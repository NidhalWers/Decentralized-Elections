{% extends "base/base.html" %}

{% block body %}
{% load static %}
<div id="Election">
    <div class="row">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Accueil</a></li>
                <li class="breadcrumb-item active" aria-current="page">Voir l'élection</li>
            </ol>
        </nav> 
    </div>
    <div class="row">
        <div class="col-lg-3 col-md-6">
            <div class="card border-bottom border-4 border-0 border-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span>Statut</span>
                    </div>
                    <div>
                        <span class="counter">[[election[0].ElectionStatus]]</span>
                    </div>
                </div>
            </div>
            </div>
        </div>  
        <div class="col-lg-6 col-md-0">
            <p class="h1 d-flex justify-content-center">[[election[0].ElectionName]]</p>
            <p class="h6 d-flex justify-content-center">Résultat de l'élection</p>
        </div> 
        <div class="col-lg-3 col-md-6">
            <div class="card border-bottom border-4 border-0 border-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span>Terminée depuis :</span>
                    </div>
                </div>
                <div>
                    <span>[[printDate(election[0].ElectionEndDate)]]</span>
                </div>
            </div>
            </div>
        </div>
    </div>
    <div class="row pb-4">
        <div class="col-lg-2">
            <button type="button" class="btn btn-primary">Modifier les candidats</button>
        </div>
        <div class="col-lg-2">
            <button v-on:click="delElection()" type="button" class="btn btn-danger">Supprimer l'élection</button>
        </div>

        <div class="form-check form-switch form-check-inline col-lg-2 float-end">
            <input class="form-check-input" type="checkbox" id="switch2" v-model="election[0].ElectionBlind" v-on:click="updateElection()"/>
            <label class="form-check-label pl-2" for="switch2">Cacher l'élection</label>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="card" data-aos="fade-up" data-aos-delay="1000">
                <div class="flex-wrap card-header d-flex justify-content-between">
                    <div class="header-title">
                        <h4 class="card-title">Répartitions des votes</h4>            
                    </div>
                </div>
                <div class="card-body">
                    <div id="d-activity" class="d-activity"></div>
                </div>
            </div>
        </div>         
        <div class="col-md-12 col-lg-12">
            <div class="overflow-hidden card" data-aos="fade-up" data-aos-delay="600">
                <div class="flex-wrap card-header d-flex justify-content-between">
                <div class="header-title">
                    <h4 class="mb-2 card-title">Visualisation détaillées des votes</h4>
                    <p class="mb-0">
                        <svg class ="me-2 text-primary" width="24" height="24" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z" />
                        </svg>
                        150 votes au total
                    </p>            
                </div>
                <div class="dropdown">
                    <span class="dropdown-toggle" id="dropdownMenuButton7" data-bs-toggle="dropdown" aria-expanded="false" role="button">
                    </span>
                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton7">
                        <a class="dropdown-item " href="javascript:void(0);">Action</a>
                        <a class="dropdown-item " href="javascript:void(0);">Another action</a>
                        <a class="dropdown-item " href="javascript:void(0);">Something else here</a>
                    </div>
                </div>
                </div>
                <div class="p-0 card-body">
                <div class="mt-4 table-responsive">
                    <table id="basic-table" class="table mb-0 table-striped" role="grid">
                        <thead>
                            <tr>
                            <th>COMPANIES</th>
                            <th>CONTACTS</th>
                            <th>ORDER</th>
                            <th>COMPLETION</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img class="rounded bg-soft-primary img-fluid avatar-40 me-3" src="../assets/images/shapes/01.png" alt="profile">
                                    <h6>Addidis Sportwear</h6>
                                </div>
                            </td>
                            <td>
                                <div class="iq-media-group iq-media-group-1">
                                    <a href="#" class="iq-media-1">
                                        <div class="icon iq-icon-box-3 rounded-pill">SP</div>
                                    </a>
                                    <a href="#" class="iq-media-1">
                                        <div class="icon iq-icon-box-3 rounded-pill">PP</div>
                                    </a>
                                    <a href="#" class="iq-media-1">
                                        <div class="icon iq-icon-box-3 rounded-pill">MM</div>
                                    </a>
                                </div>
                            </td>
                            <td>$14,000</td>
                            <td>
                                <div class="mb-2 d-flex align-items-center">
                                    <h6>60%</h6>
                                </div>
                                <div class="shadow-none progress bg-soft-primary w-100" style="height: 4px">
                                    <div class="progress-bar bg-primary" data-toggle="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </td>
                            </tr>
                            <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img class="rounded bg-soft-primary img-fluid avatar-40 me-3" src="../assets/images/shapes/05.png" alt="profile">
                                    <h6>Netflixer Platforms</h6>
                                </div>
                            </td>
                            <td>
                                <div class="iq-media-group iq-media-group-1">
                                    <a href="#" class="iq-media-1">
                                        <div class="icon iq-icon-box-3 rounded-pill">SP</div>
                                    </a>
                                    <a href="#" class="iq-media-1">
                                        <div class="icon iq-icon-box-3 rounded-pill">PP</div>
                                    </a>
                                </div>
                            </td>
                            <td>$30,000</td>
                            <td>
                                <div class="mb-2 d-flex align-items-center">
                                    <h6>25%</h6>
                                </div>
                                <div class="shadow-none progress bg-soft-primary w-100" style="height: 4px">
                                    <div class="progress-bar bg-primary" data-toggle="progress-bar" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </td>
                            </tr>
                            <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img class="rounded bg-soft-primary img-fluid avatar-40 me-3" src="../assets/images/shapes/02.png" alt="profile">
                                    <h6>Shopifi Stores</h6>
                                </div>
                            </td>
                            <td>                                 
                                <div class="iq-media-group iq-media-group-1">
                                    <a href="#" class="iq-media-1">
                                        <div class="icon iq-icon-box-3 rounded-pill">PP</div>
                                    </a>
                                    <a href="#" class="iq-media-1">
                                        <div class="icon iq-icon-box-3 rounded-pill">TP</div>
                                    </a>
                                </div>
                            </td>
                            <td>$8,500</td>
                            <td>
                                <div class="mb-2 d-flex align-items-center">
                                    <h6>100%</h6>
                                </div>
                                <div class="shadow-none progress bg-soft-success w-100" style="height: 4px">
                                    <div class="progress-bar bg-success" data-toggle="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </td>
                            </tr>
                            <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img class="rounded bg-soft-primary img-fluid avatar-40 me-3" src="../assets/images/shapes/03.png" alt="profile">
                                    <h6>Bootstrap Technologies</h6>
                                </div>
                            </td>
                            <td>
                                <div class="iq-media-group iq-media-group-1">
                                    <a href="#" class="iq-media-1">
                                        <div class="icon iq-icon-box-3 rounded-pill">SP</div>
                                    </a>
                                    <a href="#" class="iq-media-1">
                                        <div class="icon iq-icon-box-3 rounded-pill">PP</div>
                                    </a>
                                    <a href="#" class="iq-media-1">
                                        <div class="icon iq-icon-box-3 rounded-pill">MM</div>
                                    </a>
                                    <a href="#" class="iq-media-1">
                                        <div class="icon iq-icon-box-3 rounded-pill">TP</div>
                                    </a>
                                </div>
                            </td>
                            <td>$20,500</td>
                            <td>
                                <div class="mb-2 d-flex align-items-center">
                                    <h6>100%</h6>
                                </div>
                                <div class="shadow-none progress bg-soft-success w-100" style="height: 4px">
                                    <div class="progress-bar bg-success" data-toggle="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </td>
                            </tr>
                            <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img class="rounded bg-soft-primary img-fluid avatar-40 me-3" src="../assets/images/shapes/04.png" alt="profile">
                                    <h6>Community First</h6>
                                </div>
                            </td>
                            <td>
                                <div class="iq-media-group iq-media-group-1">
                                    <a href="#" class="iq-media-1">
                                        <div class="icon iq-icon-box-3 rounded-pill">MM</div>
                                    </a>
                                </div>
                            </td>
                            <td>$9,800</td>
                            <td>
                                <div class="mb-2 d-flex align-items-center">
                                    <h6>75%</h6>
                                </div>
                                <div class="shadow-none progress bg-soft-primary w-100" style="height: 4px">
                                    <div class="progress-bar bg-primary" data-toggle="progress-bar" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                </div>
            </div>
        </div>
    </div>
</div>  
<!-- vue:js -->
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.0"></script>
<!-- axios:js -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    var parametre = new Vue({
        delimiters: ['[[', ']]'],
        el: '#Election',
        data() {
                return {
                    election:[{
                        "ElectionName": "",
                        "ElectionStatus": "",
                        "ElectionBlind": false,
                    }],
                    actualTime:"",
                    currentDates:"",
                    candidates:[],
                    timeRemaining:0,
                    electionStarted: true,
                    electionBlind: false,
                    resultElection:{}
                }
        },
        async mounted() {
            await this.getElection()
            await this.fillCandidates()
            await this.getElectionResults()
        },    
        methods: {
            getElection: async function () {
                electionName = "{{name}}"
                electionStatus = "{{status}}"
                if(electionStatus != "None"){
                    await axios
                        .get('/adminspace/api/getElectionStatus/'+electionName+'/'+electionStatus)
                        .then(response => (this.election = response.data))
                        .catch(response => (console.log(response.data))); 
                }
                else{
                    await axios
                        .get('/adminspace/api/getElection/'+electionName)
                        .then(response => (this.election = response.data))
                        .catch(response => (console.log(response.data))); 
                };
                this.election[0].ElectionCandidates = this.election[0].ElectionCandidates.split(",");
            },
            updateElection: async function () {
                let formData = new FormData();
                formData.append('ElectionName', this.election[0].ElectionName);
                formData.append('ElectionBlind', !this.election[0].ElectionBlind);
                if(this.election[0].ElectionStatus != ""){
                    await axios
                        .put('/adminspace/api/updateElectionStatus/'+this.election[0].ElectionName+'/'+this.election[0].ElectionStatus,formData,{
                        headers: {
                            'Content-Type': 'multipart/form-data',
                            "X-CSRFToken": "{{ csrf_token }}",
                        }
                        })
                        .then(function (response) {
                            console.log(response);
                        })
                        .catch(response => (console.log(response.data)));
                }else{
                    await axios
                        .put('/adminspace/api/updateElection/'+this.election[0].ElectionName,formData,{
                        headers: {
                            'Content-Type': 'multipart/form-data',
                            "X-CSRFToken": "{{ csrf_token }}",
                        }
                        })
                        .then(function (response) {
                            console.log(response);
                        })
                        .catch(response => (console.log(response.data)));
                }
                this.getElection()
            },
            currentDate: function() {
                const today = new Date();
                    const year = today.getFullYear();
                    const month = ('0'+today.getMonth()+1).slice(-2);
                    const day = ('0'+today.getDate()).slice(-2);
                    const hour = ('0'+today.getHours()).slice(-2);
                    const minute = ('0'+today.getMinutes()).slice(-2);
                    const second = ('0'+today.getSeconds()).slice(-2);
                    // const time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
                    // const date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+(today.getDate());
                    const dateTime = year +'-'+ month+'-'+day+'T'+hour+':'+minute+':'+second+'Z'; 
                    // const currentDateTime = year +'-'+ month+'-'+day+' '+hour+':'+minute+':'+second;
                    const currentDateTime = day +'/'+ month+'/'+year+' '+hour+':'+minute+':'+second;
                    // this.dateTime = moment(dateTime).format('YYYY-MM-DD[T]HH:mm:ss[Z]');
                    this.currentDates = currentDateTime;
                    this.actualTime = dateTime;
                },

                printDate: function(date) {
                    date = new Date(date);
                    const year = date.getFullYear();
                    const month = ('0'+date.getMonth()+1).slice(-2);
                    const day = ('0'+date.getDate()).slice(-2);
                    const hour = ('0'+date.getHours()).slice(-2);
                    const minute = ('0'+date.getMinutes()).slice(-2);
                    const second = ('0'+date.getSeconds()).slice(-2);
                    const DateTime = year +'-'+ month+'-'+day+' '+hour+':'+minute+':'+second;
                    const DateTime2 = day +'/'+ month+'/'+year+' '+hour+':'+minute+':'+second;
                    return DateTime2;
                },

                getCandidate: async function(candidateName){
                    await axios
                    .get('/adminspace/api/getCandidate/'+candidateName)
                    .then(response => (this.candidate = response.data))
                    .catch(response => (console.log(response.data)));
                },
                fillCandidates: async function(){
                    for(var candidate in this.election[0].ElectionCandidates){
                        try{
                            await axios
                                .get('/adminspace/api/getCandidate/'+this.election[0].ElectionCandidates[candidate])
                                .then(response => (this.candidates.push(response.data)))
                            
                        }catch(error){
                            console.log(error)
                        }
                    }
                },
                delElection: async function(){
                    if(this.election[0].ElectionStatus != ""){
                        await axios
                            .delete('/adminspace/api/delElectionStatus/'+this.election[0].ElectionName+"/"+this.election[0].ElectionStatus,{
                            headers: {
                                'Content-Type': 'multipart/form-data',
                                "X-CSRFToken": "{{ csrf_token }}",
                            }
                        })
                        .then(function (response) {
                            console.log(response);
                        })
                        .catch(response => (console.log(response.data)));
                    }
                    else{
                        await axios
                            .delete('/adminspace/api/delElection/'+this.election[0].ElectionName,{
                            headers: {
                                'Content-Type': 'multipart/form-data',
                                "X-CSRFToken": "{{ csrf_token }}",
                            }
                        })
                        .then(function (response) {
                            console.log(response);
                        })
                        .catch(response => (console.log(response.data)));
                    }
                    window.location.href = "/";
                },
                getElectionResults: async function(){
                    electionName = "{{name}}"
                    electionStatus = "{{status}}"
                    event.preventDefault();
                    this.loading=true

                    if(electionStatus == "None"){
                        statusElection = ""
                    }else{
                        statusElection = electionStatus
                    }

                    var data = JSON.stringify({
                        "status" : statusElection
                        });

                    var config = {
                        method: 'post',
                        url: 'http://localhost:8080/smart-vote/api/v1/get-sandbox/',
                        // url: 'http://localhost:8080/smart-vote/api/v1/get-election/'+electionName,
                        headers: { 
                            'Content-Type': 'application/json',
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                        data : data
                    };

                    try{
                        await axios(config)
                        .then(response => (this.resultElection = response.data))
                        
                        this.assignResultToCandidate()
                        console.log(this.resultElection)
                        this.loading=false
                    }catch(error){
                        console.log(error)
                        // this.printError("Une erreur est survenue lors de la création de l'élection dans la blockchain",error["message"])
                        this.loading=false
                    }
                },
                assignResultToCandidate: async function() {
                    for(key in this.resultElection["candidates_results"]){
                        try{
                            this.candidates[key]["CandidateResult"] = this.resultElection["candidates_results"][key]["candidate_result"]
                        }catch(error){
                            console.log(error)
                        }
                    }
                }
            },
        },
    );
</script>
{% endblock %}